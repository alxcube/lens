<script src="lens.min.js"></script>
<script src="js/common.js"></script>

<style>
    .src-img {
        float: left;
        margin-right: 20px;
    }

    .src-images img {
        display: block;
    }
</style>

<p>
    Let's make 3d cube from these images and place text over it. (See page source)
</p>

<div class="src-images">
    <div class="src-img">
        <img src="img/butterfly.jpg" alt="">
        <small>
            Image by <a
                href="https://pixabay.com/users/DreamyArt-512893/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4741740">DreamyArt</a>
            from <a
                href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4741740">Pixabay</a>
        </small>
    </div>

    <div class="src-img">
        <img src="img/web.jpg" alt="">
        <small>
            Image by <a
                href="https://pixabay.com/users/ka_re-14461006/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4804526">Kai
            Reschke</a> from <a
                href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4804526">Pixabay</a>
        </small>
    </div>

    <div class="src-img">
        <img src="img/boat.jpg" alt="">
        <small>
            Image by <a
                href="https://pixabay.com/users/enriquelopezgarre-3764790/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4777340">enriquelopezgarre</a>
            from <a
                href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4777340">Pixabay</a>
        </small>
    </div>
</div>

<div id="result" style="clear: both;"></div>

<script>
    var outputSize = 210; // Output square image size

    var edgeSize = (outputSize - 10) / 2; // Cube edge size

    // Cube center coords
    var centerX, centerY;
    centerX = centerY = outputSize / 2;

    // Cube apexes coords
    var northX = centerX;
    var northY = centerY - edgeSize;
    var northWestX = Math.cos(lens.util.deg2rad(30)) * (-edgeSize) + centerX;
    var northWestY = Math.sin(lens.util.deg2rad(30)) * (-edgeSize) + centerY;
    var northEastX = Math.cos(lens.util.deg2rad(30)) * edgeSize + centerX;
    var northEastY = northWestY;
    var southWestX = northWestX;
    var southWestY = northWestY + edgeSize;
    var southEastX = northEastX;
    var southEastY = southWestY;
    var southX = centerX;
    var southY = centerY + edgeSize;

    // Create canvas for result image
    var canvas = document.createElement('canvas');
    canvas.width = outputSize;
    canvas.height = outputSize;
    document.getElementById('result').appendChild(canvas);
    var ctx = canvas.getContext('2d');


    function makeCubeSide(
      img,
      topLeftX, topLeftY, // Where top left image apex goes
      topRightX, topRightY, // ...same top right
      bottomRightX, bottomRightY, // ...same bottom right
      bottomLeftX, bottomLeftY // ...same bottom left
    ) {
      // Make image adapter
      var image = new lens.image.DomImage(img);

      // Distort image
      return lens.distort(
        image,
        lens.distorts.AFFINE,
        // move image corners to given cube apexes
        [
          0, 0, topLeftX, topLeftY,
          image.width - 1, 0, topRightX, topRightY,
          image.width - 1, image.height - 1, bottomRightX, bottomRightY,
          0, image.height - 1, bottomLeftX, bottomLeftY
        ],
        {
          bestFit: true // calculate best fit viewport
        }
      ).then(function (distorted) {
        // Compose distorted image onto canvas using calculated best-fit viewport
        ctx.drawImage(
          distorted.canvas, // we could use `image` prop instead
          distorted.viewport.x1,
          distorted.viewport.y1,
          distorted.width,
          distorted.height
        );

        return distorted;
      });
    }

    var butterfly = preloadImage('img/butterfly.jpg')
      .then(function (img) {
        // Place on top of cube
        return makeCubeSide(
          img,
          northX, northY,
          northEastX, northEastY,
          centerX, centerY,
          northWestX, northWestY
        );
      });

    var web = preloadImage('img/web.jpg')
      .then(function (img) {
        // Place on the left of cube
        return makeCubeSide(
          img,
          northWestX, northWestY,
          centerX, centerY,
          southX, southY,
          southWestX, southWestY
        );
      });

    var boat = preloadImage('img/boat.jpg')
      .then(function (img) {
        // Place on the right of cube and rotate 90 deg clockwise
        return makeCubeSide(
          img,
          northEastX, northEastY,
          southEastX, southEastY,
          southX, southY,
          centerX, centerY
        );
      });

    // Load text image
    var text = preloadImage('img/white-text.png')
      .then(function (img) {
        var image = new lens.image.DomImage(img);

        return lens.distort(
          image,
          lens.distorts.ARC,
          [
            360, // Arc angle â€” full circle
            0, // Do not rotate result
            edgeSize * 0.8, // Outer radius of text circle,
            edgeSize * 0.4 // Inner radius of text circle
          ]
        );
      });

    // Draw text over image when cube has been completed
    Promise.all([butterfly, web, boat]).then(function () {
      text.then(function (distortedText) {
        // Compose images: fit arc distortion center point to cube center
        ctx.drawImage(
          distortedText.canvas,
          distortedText.viewport.x1 + centerX,
          distortedText.viewport.y1 + centerY,
          distortedText.width,
          distortedText.height
        );
      });
    });

</script>