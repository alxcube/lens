/*!
 * @alxcube/lens 0.1.0
 * Â© 2020 Alexander Alexandrov <alxcube@gmail.com>
 * License: Apache-2.0
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.lens=e():t.lens=e()}(this,(function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var n={};r.r(n),r.d(n,"blendColors",(function(){return A})),r.d(n,"perceptibleReciprocal",(function(){return E})),r.d(n,"rad2deg",(function(){return P})),r.d(n,"deg2rad",(function(){return M}));var i={};function o(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}r.r(i),r.d(i,"box",(function(){return vt})),r.d(i,"cubicBC",(function(){return mt}));var a=function(){function t(e,r,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.image=e,this.mapper=r,this.resampler=n,this.bestFit=!1,this.viewport=null,this.async=!0,this.outputScaling=1}var e,r,n;return e=t,(r=[{key:"distort",value:function(){var t=this;this.resampler.setImage(this.image),this.resampler.setMapper(this.mapper);var e=this.prepareViewport(),r=Math.floor(e.x1),n=Math.floor(e.y1),i=Math.floor(e.x2),o=Math.floor(e.y2),a=this.image.getBlank(e);return this.resampler.scaling=1/this.outputScaling,a instanceof Promise?a.then((function(e){return t.performDistortionAsync(e,r,n,i,o)})):this.async?this.performDistortionAsync(a,r,n,i,o):this.performDistortion(a,r,n,i,o)}},{key:"performDistortion",value:function(t,e,r,n,i){for(var o=r;o<=i;o++)for(var a=e;a<=n;a++)t.setPixelColor(a,o,this.resampler.getResampledColor(a+.5,o+.5));return t}},{key:"performDistortionAsync",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return new Promise((function(e){return setTimeout((function(){return e(t.performDistortion.apply(t,r),0)}))}))}},{key:"prepareViewport",value:function(){var t;return(t=this.viewport?this.viewport.clone():this.bestFit&&this.mapper.hasBestFitViewport?this.mapper.getBestFitViewport(this.image.viewport):this.image.viewport.clone()).scale(this.outputScaling),t}}])&&o(e.prototype,r),n&&o(e,n),t}(),s={ReversePixelMapping:a};function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function l(t){var e="function"==typeof Map?new Map:void 0;return(l=function(t){if(null===t||(r=t,-1===Function.toString.call(r).indexOf("[native code]")))return t;var r;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return h(t,arguments,p(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),f(n,t)})(t)}function h(t,e,r){return(h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var i=new(Function.bind.apply(t,n));return r&&f(i,r.prototype),i}).apply(null,arguments)}function f(t,e){return(f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var y=function(t){function e(t){var r,n,i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),n=this,(r=!(i=p(e).call(this,t))||"object"!==u(i)&&"function"!=typeof i?c(n):i).name="LensException","function"==typeof Error.captureStackTrace?Error.captureStackTrace(c(r),r.constructor):r.stack=new Error(t).stack,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&f(t,e)}(e,t),e}(l(Error));function v(t){return(v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function m(t,e){return!e||"object"!==v(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function g(t){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function b(t,e){return(b=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var d=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=m(this,g(e).call(this,t))).name="UnsolvableMatrix",r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&b(t,e)}(e,t),e}(y),w=1e-12,x=Math.PI/2,O=2*Math.PI;function E(t){var e=t<0?-1:1;return e*t>=w?1/t:e/w}function A(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return null===n&&(n=1-e),t.map((function(t,i){return Math.round(t*e+r[i]*n)}))}function P(t){return 180*t/Math.PI}function M(t){return Math.PI*t/180}function C(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function j(t,e,r,n,i){t[e][r]!==t[n][i]&&(t[e][r]+=t[n][i],t[n][i]=t[e][r]-t[n][i],t[e][r]-=t[n][i])}function I(){throw new d("Can't solve given matrix using Gauss-Jordan method")}var k=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.solved=!1,this.matrix=e.map((function(t){return t.slice()})),this.vectors=r.map((function(t){return t.slice()}))}var e,r,n;return e=t,(r=[{key:"solve",value:function(){if(this.solved)return this;this.validate();for(var t=this.matrix,e=this.vectors,r=t.length,n=e.length,i=new Array(r).fill(0),o=new Array(r).fill(0),a=new Array(r).fill(0),s=0,u=0,c=0;c<r;c++){for(var l=0,h=0;h<r;h++)if(1!==a[h])for(var f=0;f<r;f++)0!==a[f]?a[f]>1&&I():Math.abs(t[h][f])>=l&&(l=Math.abs(t[h][f]),u=h,s=f);if(a[s]++,u!==s){for(var p=0;p<r;p++)j(t,u,p,s,p);for(var y=0;y<n;y++)j(e,y,u,y,s)}o[c]=u,i[c]=s,0===t[s][s]&&I();var v=E(t[s][s]);t[s][s]=1;for(var m=0;m<r;m++)t[s][m]*=v;for(var g=0;g<n;g++)e[g][s]*=v;for(var b=0;b<r;b++)if(b!==s){var d=t[b][s];t[b][s]=0;for(var w=0;w<r;w++)t[b][w]-=d*t[s][w];for(var x=0;x<n;x++)e[x][b]-=d*e[x][s]}}for(var O=r-1;O>=0;O--)if(i[O]!==o[O])for(var A=0;A<r;A++)j(t,A,o[O],A,i[O]);return this.solved=!0,this}},{key:"getVectors",value:function(){return this.vectors.map((function(t){return t.slice()}))}},{key:"validate",value:function(){var t=this.matrix.length;return this.matrix.forEach((function(e){if(e.length!==t)throw new Error("Matrix must be square")})),this.vectors.forEach((function(e){if(e.length!==t)throw new Error("Vectors must be the same length as matrix rank")})),this}}])&&C(e.prototype,r),n&&C(e,n),t}();function S(t){return(S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function T(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function R(t,e){return!e||"object"!==S(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function _(t){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function L(t,e){return(L=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var V=function(t){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);for(var n=[],i=[],o=0;o<t;o++)n.push(new Array(t).fill(0));for(var a=0;a<r;a++)i.push(new Array(t).fill(0));return R(this,_(e).call(this,n,i))}var r,n,i;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&L(t,e)}(e,t),r=e,(n=[{key:"addTerms",value:function(t,e){for(var r=this.matrix.length,n=0;n<r;n++){for(var i=0;i<r;i++)this.matrix[i][n]+=t[i]*t[n];for(var o=0;o<this.vectors.length;o++)this.vectors[o][n]+=e[o]*t[n]}return this}}])&&T(r.prototype,n),i&&T(r,i),e}(k);function D(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var F=function(){function t(e,r,n,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.x1=e,this.y1=r,this.x2=n,this.y2=i}var e,r,n;return e=t,(r=[{key:"width",value:function(){return this.x2-this.x1+1}},{key:"height",value:function(){return this.y2-this.y1+1}},{key:"area",value:function(){return this.width()*this.height()}},{key:"contains",value:function(t,e){return t>=this.x1&&t<=this.x2&&e>=this.y1&&e<=this.y2}},{key:"expand",value:function(t,e){return this.x1=Math.min(this.x1,t),this.x2=Math.max(this.x2,t),this.y1=Math.min(this.y1,e),this.y2=Math.max(this.y2,e),this}},{key:"clone",value:function(){return new this.constructor(this.x1,this.y1,this.x2,this.y2)}},{key:"fixBounds",value:function(){return this.x1=Math.floor(this.x1-.5),this.y1=Math.floor(this.y1-.5),this.x2=Math.ceil(this.x2-.5),this.y2=Math.ceil(this.y2-.5),this}},{key:"scale",value:function(t){return this.x1=Math.round(this.x1*t),this.y1=Math.round(this.y1*t),this.x2=Math.round(this.x2*t),this.y2=Math.round(this.y2*t),this}},{key:"reset",value:function(){var t=this.width(),e=this.height();return this.x1=0,this.y1=0,this.x2=this.x1+t-1,this.y2=this.y1+e-1,this}},{key:"offset",value:function(t,e){return this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e,this}}])&&D(e.prototype,r),n&&D(e,n),t}();function B(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function N(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var G={getBestFitViewport:function(t){var e=this,r=t.x1,n=t.y1,i=t.x2+1,o=t.y2+1,a=N(this.forwardMap(r,n),2),s=a[0],u=a[1],c=new F(s,u,s,u);return[[i,n],[i,o],[r,o]].forEach((function(t){return c.expand.apply(c,B(e.forwardMap.apply(e,B(t))))})),c.fixBounds(),c}};function q(t){return(q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function U(t,e){return!e||"object"!==q(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function H(t){return(H=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function W(t,e){return(W=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var z=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=U(this,H(e).call(this,t))).name="InvalidArgumentsLength",r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&W(t,e)}(e,t),e}(y);function K(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Z(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function J(t,e,r){return[r[0]*t+r[1]*e+r[2],r[3]*t+r[4]*e+r[5]]}var X=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.matrix=e,this.forwardMatrix=this.constructor.invertAffineMatrix(e),this.hasPartialDerivatives=!0,this.hasConstantPartialDerivatives=!0,this.hasBestFitViewport=!0}var e,r,n;return e=t,n=[{key:"fromControlPoints",value:function(e){if(e.length%4!=0)throw new z("Number of arguments must be multiple of 4 and at least 4 arguments (1 control point) expected. ".concat(e.length," arguments given."));if(4===e.length)return new t([1,0,e[0]-e[2],0,1,e[1]-e[3]]);for(var r=new V(3,2),n=0;n<e.length;n+=4){var i=K(e.slice(n,n+4),4),o=i[0],a=i[1],s=i[2],u=i[3];r.addTerms([s,u,1],[o,a])}8===e.length&&r.addTerms([e[2]-(e[7]-e[3]),e[3]+(e[6]-e[2]),1],[e[0]-e[5]+e[1],e[1]+e[4]-e[0]]);var c=r.solve().getVectors();return new t(c[0].concat(c[1]))}},{key:"fromForwardMatrix",value:function(e){return new t(this.invertAffineMatrix(e))}},{key:"invertAffineMatrix",value:function(t){var e=E(t[0]*t[4]-t[1]*t[3]);return[e*t[4],e*-t[1],e*(t[1]*t[5]-t[2]*t[4]),e*-t[3],e*t[0],e*(t[2]*t[3]-t[0]*t[5])]}}],(r=[{key:"reverseMap",value:function(t,e){return J(t,e,this.matrix)}},{key:"getValidity",value:function(t,e){return 1}},{key:"getPartialDerivatives",value:function(t,e){return[this.matrix[0],this.matrix[1],this.matrix[3],this.matrix[4]]}},{key:"forwardMap",value:function(t,e){return J(t,e,this.forwardMatrix)}}])&&Z(e.prototype,r),n&&Z(e,n),t}();Object.assign(X.prototype,G);var Y=X;function Q(t){return(Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function $(t,e){return!e||"object"!==Q(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function tt(t){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function et(t,e){return(et=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var rt=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=$(this,tt(e).call(this,t))).name="InvalidArgument",r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&et(t,e)}(e,t),e}(y);function nt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function it(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var ot=function(){function t(e,r,n,i,o,a){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.viewport=e,this.c0=r,this.c1=n,this.c2=i,this.c3=o,this.c4=a,this.angleToWidth=O*this.viewport.width()/this.c1,this.radiusToHeight=this.viewport.height()/this.c3,this.hasPartialDerivatives=!0,this.hasConstantPartialDerivatives=!1,this.hasBestFitViewport=!0,this.forceBestFit=!0}var e,r,n;return e=t,n=[{key:"fromArguments",value:function(e,r){if(r.length>=1&&r[0]<w)throw new rt("Angle too small");if(r.length>=3&&r[2]<w)throw new rt("Outer radius too small");var n,i,o,a,s;return n=-x,i=r.length>=1?M(r[0]):x,r.length>=2&&(n+=M(r[1])),n/=O,n-=Math.round(n),n*=O,a=e.height()-1,o=e.width()/i+a/2,r.length>=3&&(r.length>=4?a=r[2]-r[3]:a*=r[2]/o,o=r[2]),s=(e.width()-1)/2,new t(e,n,i,o,a,s)}}],(r=[{key:"reverseMap",value:function(t,e){var r=nt(this.getUV(t,e),2),n=r[0],i=r[1];return[n=n*this.angleToWidth+this.c4+this.viewport.x1+.5,i=(this.c2-i)*this.radiusToHeight+this.viewport.y1]}},{key:"getValidity",value:function(t,e){return 1}},{key:"getPartialDerivatives",value:function(t,e){var r=nt(this.getUV(t,e),2),n=(r[0],r[1]);return n>w?[this.angleToWidth/(O*n),0,0,this.radiusToHeight]:[2*this.viewport.width(),0,0,this.radiusToHeight]}},{key:"getBestFitViewport",value:function(t){var e=this.c0-this.c1/2,r=Math.cos(e),n=Math.sin(e),i=this.c2*r,o=this.c2*n,a=new F(i,o,i,o);for(i=(this.c2-this.c3)*r,o=(this.c2-this.c3)*n,a.expand(i,o),e=this.c0+this.c1/2,r=Math.cos(e),n=Math.sin(e),i=this.c2*r,o=this.c2*n,a.expand(i,o),i=(this.c2-this.c3)*r,o=(this.c2-this.c3)*n,a.expand(i,o),e=Math.ceil((this.c0-this.c1/2)/x)*x;e<this.c0+this.c1/2;e+=x)r=Math.cos(e),n=Math.sin(e),i=this.c2*r,o=this.c2*n,a.expand(i,o);return a.fixBounds(),a}},{key:"getUV",value:function(t,e){var r;return r=(Math.atan2(e,t)-this.c0)/O,[r-=Math.round(r),Math.hypot(t,e)]}}])&&it(e.prototype,r),n&&it(e,n),t}();function at(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function st(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function ut(t,e,r){var n=r[0]*t+r[1]*e+r[2],i=r[3]*t+r[4]*e+r[5],o=r[6]*t+r[7]*e+1;return[n/o,i/o]}var ct=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.matrix=e,this.denominator=r,this.forwardMatrix=this.constructor.invertPerspectiveMatrix(e),this.hasPartialDerivatives=!0,this.hasConstantPartialDerivatives=!1,this.hasBestFitViewport=!0}var e,r,n;return e=t,n=[{key:"fromControlPoints",value:function(e){if(e.length<16||e.length%4!=0)throw new z("Number of arguments must be multiple of 4 and at least 16 arguments (4 control points) expected. ".concat(e.length," arguments given."));for(var r=new V(8,1),n=0;n<e.length;n+=4){var i=at(e.slice(n,n+4),4),o=i[0],a=i[1],s=i[2],u=i[3];r.addTerms([s,u,1,0,0,0,-s*o,-u*o],[o]).addTerms([0,0,0,s,u,1,-s*a,-u*a],[a])}var c=r.solve().getVectors()[0];return new t(c,c[6]*e[2]+c[7]*e[3]+1<0?-1:1)}},{key:"fromForwardMatrix",value:function(e){var r=this.invertPerspectiveMatrix(e);return new t(r,r[6]*e[2]+r[7]*e[5]+1<0?-1:1)}},{key:"invertPerspectiveMatrix",value:function(t){var e=E(t[0]*t[4]-t[3]*t[1]);return[e*(t[4]-t[7]*t[5]),e*(t[7]*t[2]-t[1]),e*(t[1]*t[5]-t[4]*t[2]),e*(t[6]*t[5]-t[3]),e*(t[0]-t[6]*t[2]),e*(t[3]*t[2]-t[0]*t[5]),e*(t[3]*t[7]-t[6]*t[4]),e*(t[6]*t[1]-t[0]*t[7])]}}],(r=[{key:"reverseMap",value:function(t,e){return ut(t,e,this.matrix)}},{key:"getValidity",value:function(t,e,r){var n=this.matrix[6]*t+this.matrix[7]*e+1,i=n*this.denominator<0?0:1,o=2*Math.abs(n),a=Math.abs(this.matrix[6]),s=Math.abs(this.matrix[7]);return a>s?o<a&&(i=.5-this.denominator*n/(this.matrix[6]*r)):o<s&&(i=.5-this.denominator*n/(this.matrix[7]*r)),i}},{key:"getPartialDerivatives",value:function(t,e){var r=this.matrix[0]*t+this.matrix[1]*e+this.matrix[2],n=this.matrix[3]*t+this.matrix[4]*e+this.matrix[5],i=this.matrix[6]*t+this.matrix[7]*e+1,o=Math.pow(1/i,2);return[(i*this.matrix[0]-r*this.matrix[6])*o,(i*this.matrix[1]-r*this.matrix[7])*o,(i*this.matrix[3]-n*this.matrix[6])*o,(i*this.matrix[4]-n*this.matrix[7])*o]}},{key:"forwardMap",value:function(t,e){return ut(t,e,this.forwardMatrix)}}])&&st(e.prototype,r),n&&st(e,n),t}();Object.assign(ct.prototype,G);var lt=ct,ht={Affine:Y,Arc:ot,Perspective:lt},ft={InvalidArgument:rt,InvalidArgumentsLength:z,LensException:y,UnsolvableMatrix:d};function pt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var yt=function(){function t(e,r,n,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.filterFunction=e,this.windowingFunction=r,this.support=n,this.scale=i,this.blur=o,this.windowSupport=null!==a?a:n}var e,r,n;return e=t,(r=[{key:"getWeight",value:function(t){var e=t/this.blur;return(e<w?1:this.window(this.scale*e))*this.filter(e)}},{key:"filter",value:function(t){return this.filterFunction(t,this.support,this.windowSupport)}},{key:"window",value:function(t){return this.windowingFunction(t,this.support,this.windowSupport)}}])&&pt(e.prototype,r),n&&pt(e,n),t}();function vt(){var t=function(){return 1};return t.filterFunctionName="box",t}function mt(t,e){var r=(6-2*t)/6,n=(12*t-18+6*e)/6,i=(12-9*t-6*e)/6,o=(8*t+24*e)/6,a=(-12*t-48*e)/6,s=(6*t+30*e)/6,u=(-1*t-6*e)/6,c=function(t){return t<1?r+t*(t*(n+t*i)):t<2?o+t*(a+t*(s+t*u)):0};return c.filterFunctionName="cubicBC",c.b=t,c.c=e,c}var gt={Filter:yt,filterFunctions:i},bt={BACKGROUND:1,EDGE:3,MIRROR:4,RANDOM:5,TILE:6,TRANSPARENT:7,BLACK:9,GRAY:10,WHITE:11,HORIZONTAL_TILE:12,VERTICAL_TILE:13,HORIZONTAL_TILE_EDGE:14,VERTICAL_TILE_EDGE:15};function dt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function wt(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function xt(t,e,r,n){return[Math.max(0,Math.min(r-1,t)),Math.max(0,Math.min(n-1,e))]}function Ot(t,e,r,n){var i=t%r,o=e%n;return[i<0?r+i:i,o<0?n+o:o]}var Et={getVirtualPixelColor:function(t,e,r){switch(r){case bt.BACKGROUND:return this.backgroundColor.slice();case bt.EDGE:return this.getImagePixelColor.apply(this,wt(xt(t,e,this.width,this.height)));case bt.MIRROR:var n=dt(Ot(t,e,2*this.width,2*this.height),2),i=n[0],o=n[1];return i>this.width-1&&(i=this.width-(i-this.width)-1),o>this.height-1&&(o=this.height-(o-this.height)-1),this.getImagePixelColor(i,o);case bt.TILE:return this.getImagePixelColor.apply(this,wt(Ot(t,e,this.width,this.height)));case bt.TRANSPARENT:default:return[0,0,0,0];case bt.BLACK:return[0,0,0,this.quantumRange];case bt.WHITE:return new Array(4).fill(this.quantumRange);case bt.GRAY:return new Array(3).fill(Math.round(this.quantumRange/2)).concat([this.quantumRange]);case bt.HORIZONTAL_TILE:case bt.HORIZONTAL_TILE_EDGE:return e<0||e>=this.height?r===bt.HORIZONTAL_TILE?this.backgroundColor.slice():this.getImagePixelColor.apply(this,wt(xt(t,e,this.width,this.height))):this.getImagePixelColor.apply(this,wt(Ot(t,e,this.width,this.height)));case bt.VERTICAL_TILE:case bt.VERTICAL_TILE_EDGE:return t<0||t>=this.width?r===bt.VERTICAL_TILE?this.backgroundColor.slice():this.getImagePixelColor.apply(this,wt(xt(t,e,this.width,this.height))):this.getImagePixelColor.apply(this,wt(Ot(t,e,this.width,this.height)));case bt.RANDOM:return this.getImagePixelColor(Math.floor(Math.random()*this.width),Math.floor(Math.random()*this.height))}}},At={AVERAGE:1,AVERAGE_9:2,AVERAGE_16:3,BACKGROUND:4,INTEGER:8},Pt={getInterpolatedPixelColor:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.interpolationMethod;switch(r){case At.AVERAGE:return this.interpolateAverage(t,e,2);case At.AVERAGE_9:return this.interpolateAverage(t,e,3);case At.AVERAGE_16:return this.interpolateAverage(t,e,4);case At.BACKGROUND:return this.backgroundColor.slice();case At.INTEGER:default:return this.getPixelColor(Math.floor(t),Math.floor(e))}},interpolateAverage:function(t,e){var r,n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;switch(i){case 2:r=Math.floor(t),n=Math.floor(e);break;case 3:r=Math.floor(t+.5)-1,n=Math.floor(e+.5)-1;break;case 4:r=Math.floor(t)-1,n=Math.floor(e)-1;break;default:throw new Error("Param 'count' must be integer between 2 and 4.")}for(var o=r+i,a=n+i,s=[0,0,0,0],u=n;u<a;u++)for(var c=r;c<o;c++)this.getPixelColor(t,e).forEach((function(t,e){return s[e]+=t}));var l=1/(i*i);return s.map((function(t){return Math.round(t*l)}))}};function Mt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Ct(t){throw new Error("".concat(t,"() is abstract method and must be implemented by child class"))}var jt=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.width=e,this.height=r,this.viewport=new F(0,0,this.width-1,this.height-1),this.backgroundColor=[0,0,0,0],this.virtualPixelMethod=bt.TRANSPARENT,this.quantumRange=255,this.interpolationMethod=At.INTEGER}var e,r,n;return e=t,(r=[{key:"getPixelColor",value:function(t,e){return t=Math.floor(t-this.viewport.x1),e=Math.floor(e-this.viewport.y1),t>=0&&t<this.width&&e>=0&&e<this.height?this.getImagePixelColor(t,e):this.getVirtualPixelColor(t,e,this.virtualPixelMethod)}},{key:"setPixelColor",value:function(t,e,r){if(t=Math.floor(t-this.viewport.x1),e=Math.floor(e-this.viewport.y1),t>=0&&t<this.width&&e>=0&&e<this.height)return this.setImagePixelColor(t,e,r),this;throw new Error("Given coords (".concat(t,", ").concat(e,") is out of image bounds"))}},{key:"getBlank",value:function(t){var e=this.prepareBlank(t.width(),t.height());return e instanceof Promise?e.then((function(e){return e.viewport=t,e})):(e.viewport=t,e)}},{key:"scale",value:function(t){var e=this.viewport.clone();e.scale(t);var r=this.resize(e.width(),e.height());return r instanceof Promise?r.then((function(){return r.viewport=e,r})):(r.viewport=e,r)}},{key:"sync",value:function(){return this}},{key:"getImagePixelColor",value:function(t,e){Ct("getImagePixelColor")}},{key:"setImagePixelColor",value:function(t,e,r){Ct("setImagePixelColor")}},{key:"prepareBlank",value:function(t,e){Ct("prepareBlank")}},{key:"getAverageColor",value:function(){Ct("getAverageColor")}},{key:"resize",value:function(t,e){Ct("resize")}}])&&Mt(e.prototype,r),n&&Mt(e,n),t}();Object.assign(jt.prototype,Et),Object.assign(jt.prototype,Pt);var It=jt;function kt(t){return(kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function St(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Tt(t,e){return!e||"object"!==kt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Rt(t){return(Rt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _t(t,e){return(_t=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var Lt=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=Tt(this,Rt(e).call(this,t.width,t.height))).canvas=t,r.imageData=t.getContext("2d").getImageData(0,0,t.width,t.height),r.data=r.imageData.data,r}var r,n,i;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_t(t,e)}(e,t),r=e,(n=[{key:"getImagePixelColor",value:function(t,e){var r=4*(e*this.width+t);return Array.prototype.slice.call(this.data,r,r+4)}},{key:"setImagePixelColor",value:function(t,e,r){var n=this,i=4*(e*this.width+t);r.forEach((function(t,e){return n.data[i+e]=t}))}},{key:"prepareBlank",value:function(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,new this.constructor(r)}},{key:"sync",value:function(){return this.canvas.getContext("2d").putImageData(this.imageData,0,0),this}},{key:"getAverageColor",value:function(){var t=document.createElement("canvas");return t.width=1,t.height=1,t.getContext("2d").drawImage(this.canvas,0,0,this.width,this.height,0,0,1,1),Array.prototype.slice.call(t.getContext("2d").getImageData(0,0,1,1).data)}},{key:"resize",value:function(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,r.getContext("2d").drawImage(this.canvas,0,0,this.width,this.height,0,0,t,e),new this.constructor(r)}}])&&St(r.prototype,n),i&&St(r,i),e}(It);function Vt(t){return(Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Dt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Ft(t,e){return!e||"object"!==Vt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Bt(t,e,r){return(Bt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=Nt(t)););return t}(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(r):i.value}})(t,e,r||t)}function Nt(t){return(Nt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Gt(t,e){return(Gt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var qt=function(t){function e(t){var r;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=document.createElement("canvas");return n.width=t.width,n.height=t.height,n.getContext("2d").drawImage(t,0,0),(r=Ft(this,Nt(e).call(this,n))).image=t,r}var r,n,i;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Gt(t,e)}(e,t),r=e,(n=[{key:"prepareBlank",value:function(t,e){return new this.constructor(new Image(t,e))}},{key:"sync",value:function(){var t=this;return Bt(Nt(e.prototype),"sync",this).call(this),new Promise((function(e){t.image.onload=function(){return e(t)},t.image.src=t.canvas.toDataURL()}))}},{key:"resize",value:function(t,e){var r=this;return this.sync().then((function(){return new Promise((function(n){var i=document.createElement("canvas");i.width=t,i.height=e,i.getContext("2d").drawImage(r.image,0,0,r.width,r.height,0,0,t,e);var o=new Image(t,e);o.onload=function(){var t=new r.constructor(o);n(t)},o.src=i.toDataURL()}))}))}}])&&Dt(r.prototype,n),i&&Dt(r,i),e}(Lt),Ut={AbstractImage:It,Canvas:Lt,DomImage:qt},Ht={createsBestFitViewportFromApexes:G,interpolationTrait:Pt,virtualPixelTrait:Et};function Wt(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function zt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Kt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var Zt=1024;function Jt(t,e){return Math.max(0,Math.min(e,t))}function Xt(t,e,r,n){var i=t*t+e*e,o=t*r+e*n,a=o,s=r*r+n*n,u=t*n-e*r,c=u+u,l=i+s,h=(l+c)*(l-c),f=Math.sqrt(h>0?h:0),p=.5*(l+f),y=.5*(l-f),v=p-i,m=p-s,g=v*v,b=m*m,d=g>=b?o:m,w=g>=b?v:a,x=Math.sqrt(d*d+w*w),O=x>0?d/x:1,E=x>0?w/x:0,A=p<=1?1:Math.sqrt(p),P=y<=1?1:Math.sqrt(y);return[O*A,E*A,-E*P,O*P,A,P]}var Yt=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.resizeFilter=e,this.support=this.resizeFilter.support*this.resizeFilter.blur,this.matteColor=[0,0,0,0],this.weightLookupTable=function(t,e){for(var r=[],n=e*Math.sqrt(1/Zt),i=0;i<Zt;i++)r[i]=t.getWeight(Math.sqrt(i)*n);return r}(this.resizeFilter,this.support),this.image=null,this.mapper=null,this.imageViewport=null,this.imageArea=null,this.imageVirtualPixelMethod=null,this.imageAverageColor=null,this.A=0,this.B=0,this.C=0,this.F=0,this.uLimit=0,this.vLimit=0,this.uWidth=0,this.slope=0,this.ellipseIsSetUp=!1,this.limitReached=!1,this.scaling=1}var e,r,n;return e=t,(r=[{key:"getResampledColor",value:function(t,e){t*=this.scaling,e*=this.scaling;var r=this.mapper.getValidity(t,e,this.scaling);if(r>0){var n=zt(this.mapper.reverseMap(t,e),2),i=n[0],o=n[1];this.mapper.hasConstantPartialDerivatives?this.setupEllipseOnce.apply(this,Wt(this.mapper.getPartialDerivatives(t,e))):this.setupEllipse.apply(this,Wt(this.mapper.getPartialDerivatives(t,e)));var a=this.getWeightedAverage(i,o);return r<1?A(a,r,this.matteColor):a}return this.matteColor.slice()}},{key:"setImage",value:function(t){return this.image=t,this.imageViewport=this.image.viewport,this.imageArea=this.imageViewport.area(),this.imageVirtualPixelMethod=this.image.virtualPixelMethod,this.imageAverageColor=null,this}},{key:"setMapper",value:function(t){if(!t.hasPartialDerivatives)throw new Error("Pixel mapper must have partial derivatives to use this resampler");return this.mapper=t,this.ellipseIsSetUp=!1,this}},{key:"setupEllipseOnce",value:function(){return this.ellipseIsSetUp?this:(this.ellipseIsSetUp=!0,this.setupEllipse.apply(this,arguments))}},{key:"setupEllipse",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return this.limitReached=!1,r=r.map((function(e){return e*t.scaling})),this.initEllipse.apply(this,Wt(r)).scaleEllipse()}},{key:"initEllipse",value:function(){var t=Xt.apply(void 0,arguments),e=zt(t,6),r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5];return this.A=n*n+o*o,this.B=-2*(r*n+i*o),this.C=r*r+i*i,this.F=a*s,this.F*=this.F,this.limitReached=4*this.A*this.C-this.B*this.B>17976931348623157e292,this}},{key:"scaleEllipse",value:function(){if(!this.limitReached){if(this.F*=this.support*this.support,this.uLimit=Math.sqrt(this.C*this.F/(this.A*this.C-.25*this.B*this.B)),this.vLimit=Math.sqrt(this.A*this.F/(this.A*this.C-.25*this.B*this.B)),this.uWidth=Math.sqrt(this.F/this.A),this.slope=-this.B/(2*this.A),this.uWidth*this.vLimit>4*this.imageArea)return this.limitReached=!0,this;var t=Zt/this.F;this.A*=t,this.B*=t,this.C*=t}return this}},{key:"getWeightedAverage",value:function(t,e){if(this.doesntNeedResampling(t,e))return this.image.getPixelColor(t,e);if(this.limitReached)switch(this.imageVirtualPixelMethod){case bt.EDGE:case bt.HORIZONTAL_TILE_EDGE:case bt.VERTICAL_TILE_EDGE:return this.image.getInterpolatedPixelColor(t,e,At.AVERAGE);case bt.HORIZONTAL_TILE:case bt.VERTICAL_TILE:return this.image.getPixelColor(this.imageViewport.x1-1,this.imageViewport.y1-1);default:return this.getImageAverageColor()}for(var r=0,n=0,i=0,o=0,a=0,s=0,u=Math.ceil(e-this.vLimit),c=Math.floor(e+this.vLimit),l=t+(u-e)*this.slope-this.uWidth,h=2*this.uWidth+1,f=2*this.A,p=u;p<c;p++){var y=Math.ceil(l);l+=this.slope;for(var v=y+h,m=y-t,g=p-e,b=(this.A*m+this.B*g)*m+this.C*g*g,d=this.A*(2*m+1)+this.B*g,w=y;w<v;w++){if(b<Zt){var x=this.weightLookupTable[Math.floor(b)],O=zt(this.image.getPixelColor(w,p),4),E=O[0],A=O[1],P=O[2],M=O[3];s+=x*M,r+=x,i+=E*(x*=M/this.image.quantumRange),o+=A*x,a+=P*x,n+=x}b+=d,d+=f}}return n&&r?[Jt(Math.round(i/n),this.image.quantumRange),Jt(Math.round(o/n),this.image.quantumRange),Jt(Math.round(a/n),this.image.quantumRange),Jt(Math.round(s/r),this.image.quantumRange)]:this.image.getInterpolatedPixelColor(t,e)}},{key:"doesntNeedResampling",value:function(t,e){switch(this.imageVirtualPixelMethod){case bt.TRANSPARENT:case bt.BACKGROUND:case bt.BLACK:case bt.WHITE:case bt.GRAY:return this.limitReached||this.outOfImageBounds(t,e);case bt.EDGE:return t+this.uLimit<this.imageViewport.x1&&e+this.vLimit<this.imageViewport.y1||t+this.uLimit<this.imageViewport.x1&&e-this.vLimit>this.imageViewport.y2||t-this.uLimit>this.imageViewport.x2&&e+this.vLimit<this.imageViewport.y1||t-this.uLimit>this.imageViewport.x2&&e-this.vLimit>this.imageViewport.y2;case bt.HORIZONTAL_TILE:return e+this.vLimit<this.imageViewport.y1||e-this.vLimit>this.imageViewport.y2;case bt.VERTICAL_TILE:return t+this.uLimit<this.imageViewport.x1||t-this.uLimit>this.imageViewport.x2;default:return!1}}},{key:"getImageAverageColor",value:function(){return null===this.imageAverageColor&&(this.imageAverageColor=this.image.getAverageColor()),this.imageAverageColor.slice()}},{key:"outOfImageBounds",value:function(t,e){return t+this.uLimit<this.imageViewport.x1||t-this.uLimit>this.imageViewport.x2||e+this.vLimit<this.imageViewport.y1||e-this.vLimit>this.imageViewport.y2}}])&&Kt(e.prototype,r),n&&Kt(e,n),t}();function Qt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function $t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var te=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.matteColor=[0,0,0,0],this.scaling=1}var e,r,n;return e=t,(r=[{key:"setImage",value:function(t){return this.image=t,this}},{key:"setMapper",value:function(t){return this.mapper=t,this}},{key:"getResampledColor",value:function(t,e){t*=this.scaling,e*=this.scaling;var r=this.mapper.getValidity(t,e,this.scaling);if(r>0){var n=Qt(this.mapper.reverseMap(t,e),2),i=n[0],o=n[1],a=this.image.getInterpolatedPixelColor(i,o);return r<1?A(a,this.matteColor,r):a}return this.matteColor.slice()}}])&&$t(e.prototype,r),n&&$t(e,n),t}(),ee={EWA:Yt,Point:te};function re(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function ne(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var ie=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?re(Object(r),!0).forEach((function(e){ne(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):re(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({},n,{gaussJordanElimination:{Solver:k,LeastSquares:V}});var oe={ROBIDOUX:function(){return new yt(mt(.3782157550939987,.3108921224530007),vt(),2,1.1685777620836932,1)},ROBIDOUX_SHARP:function(){return new yt(mt(.2620145123990142,.3689927438004929),vt(),2,1.105822933719019,1)}},ae={bestFit:!1,filter:oe.ROBIDOUX,resample:!0,async:!0,outputScaling:1};function se(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var ue={AFFINE:function(t){return Y.fromControlPoints(t)},AFFINE_PROJECTION:function(t){var e=se(t,6),r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5];return Y.fromForwardMatrix([r,i,a,n,o,s])},PERSPECTIVE:function(t){return t.length<16?(console.warn("Perspective distortion requires at least 4 controls points mapping (u, v) -> (x, y). Affine distortion will be used."),Y.fromControlPoints(t)):lt.fromControlPoints(t)},PERSPECTIVE_PROJECTION:function(t){return lt.fromForwardMatrix(t)},ARC:function(t,e){return ot.fromArguments(e.viewport,t)}};var ce={VERSION:"0.1.0",EPSILON:w,MAXIMUM_VALUE:17976931348623157e292,M_2PI:O,M_PI2:x,distorts:ue,filterPresets:oe,interpolation:At,vpx:bt,Viewport:F,distorter:s,distortion:ht,exception:ft,filter:gt,image:Ut,mixins:Ht,resampler:ee,util:ie,distort:function(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};try{"function"==typeof e?e=e(r,t):n=r||{},n=function(t){(t=Object.assign({},ae,t)).supersample&&(t.outputScaling=t.supersample);return t}(n),e.forceBestFit&&(n.bestFit=!0);var i=function t(e){if(e instanceof Promise)return e.then((function(e){return t(e)}));if("sync"in e&&"function"==typeof e.sync)return e.sync();return e}(function(t,e,r,n){var i=new a(t,e,r);i.async=!!n.async,i.bestFit=!!n.bestFit,n.viewport&&(i.viewport=n.viewport);n.outputScaling&&(i.outputScaling=n.outputScaling,n.supersample&&(i.supersample=!0));return i}(t,e,function(t,e,r){var n;n=r.resampler?r.resampler:r.resample?new Yt(function(t){if("function"==typeof t.filter)return t.filter();return t.filter}(r)):new te;r.matteColor&&(n.matteColor=r.matteColor.slice());return n}(0,0,n),n).distort());return n.supersample&&1!==n.supersample?function t(e,r){if(e instanceof Promise)return e.then((function(e){return t(e,r)}));if("scale"in e&&"function"==typeof e.scale)return e.scale(r);console.warn("Method 'scale()' not found in image object. No scaling performed.");return e}(i,1/n.supersample):i}catch(t){if(n&&n.async)return Promise.reject(t);throw t}},registerDistortionResolver:function(t,e){ue[t]=e},unregisterDistortionResolver:function(t){delete ue[t]}};e.default=ce}]).default}));
//# sourceMappingURL=lens.min.js.map